{# app/templates/partials/form.html #}
{% load i18n %}
<div class="{{ wrapper_class|default:'mt-4' }}">
  {% if form_title %}
    <h2 class="{{ form_title_class|default:'mb-4' }}">{{ form_title }}</h2>
  {% endif %}
  <form
    {% if form_id %}id="{{ form_id }}"{% endif %}
    method="{{ form_method|default:'post' }}"
    action="{{ form_action|default:'' }}"
    {% if form_enctype %}
      enctype="{{ form_enctype }}"
    {% elif form.is_multipart %}
      enctype="multipart/form-data"
    {% endif %}
    {% if form_novalidate is not False %}novalidate{% endif %}
    {% if form_class %}class="{{ form_class }}"{% endif %}
    {% if form_attrs %}
      {% for attr_name, attr_value in form_attrs.items %}
        {{ attr_name }}="{{ attr_value }}"
      {% endfor %}
    {% endif %}
  >
    {% if form_method|default:'post'|lower != 'get' %}
      {% csrf_token %}
    {% endif %}
    {{ form.media }}
    {% for hidden_field in form.hidden_fields %}
      {{ hidden_field }}
    {% endfor %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}
    {% with summary=form.get_error_summary %}
      {% if summary %}
        <div class="alert alert-danger" role="alert" data-role="form-error-summary">
          <h3 class="h6 mb-2">{% trans "Please correct the highlighted fields:" %}</h3>
          <ul class="mb-0 ps-3">
            {% for item in summary %}
              <li>
                {% if item.field_id %}
                  <a class="alert-link" href="#{{ item.field_id }}" data-error-field-target="{{ item.field_id }}">
                    {{ item.label }}
                  </a>
                {% else %}
                  {{ item.label }}
                {% endif %}
                {% if item.errors %}
                  <span class="d-block small text-muted">{{ item.errors|first }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}
    {% for field in form.visible_fields %}
      {% with widget=field.field.widget widget_class_name=field.field.widget.attrs.data_widget_class_name|default:'' %}
        {% if widget.input_type == 'checkbox' or widget_class_name == 'CheckboxInput' %}
          <div class="form-check mb-3">
            {{ field }}
            {% if field.label %}
              <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {% endif %}
            {% if field.help_text %}
              <div id="{{ field.auto_id }}_help" class="form-text">{{ field.help_text }}</div>
            {% endif %}
            {% for error in field.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
        {% elif widget_class_name == 'CheckboxSelectMultiple' %}
          <fieldset class="mb-3">
            <legend class="form-label">{{ field.label }}</legend>
            {{ field }}
            {% if field.help_text %}
              <div id="{{ field.auto_id }}_help" class="form-text">{{ field.help_text }}</div>
            {% endif %}
            {% for error in field.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </fieldset>
        {% else %}
            <div class="mb-3">
              {% if field.label %}
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
              {% endif %}
              {{ field }}
            {% if field.help_text %}
              <div id="{{ field.auto_id }}_help" class="form-text">{{ field.help_text }}</div>
            {% endif %}
            {% for error in field.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    {% endfor %}
    {% with resolved_submit_label=submit_button_label|default:'Submit' %}
      {% if not hide_submit_button|default:False or extra_actions or extra_actions_html %}
        <div class="d-flex flex-wrap gap-2">
          {% if not hide_submit_button|default:False %}
            <button type="{{ submit_button_type|default:'submit' }}" class="{{ submit_button_class|default:'btn btn-primary' }}">
              {{ resolved_submit_label }}
            </button>
          {% endif %}
        {% if extra_actions %}
          {% for action in extra_actions %}
            {% if action.url %}
              <a href="{{ action.url }}" class="{{ action.class|default:'btn btn-outline-secondary' }}"
                 {% if action.attrs %}{% for attr_name, attr_value in action.attrs.items %} {{ attr_name }}="{{ attr_value }}"{% endfor %}{% endif %}>
                {{ action.label|default:action.text|default:action }}
              </a>
            {% elif action.html %}
              {{ action.html|safe }}
            {% else %}
              <button type="{{ action.type|default:'button' }}" class="{{ action.class|default:'btn btn-outline-secondary' }}"
                      {% if action.attrs %}{% for attr_name, attr_value in action.attrs.items %} {{ attr_name }}="{{ attr_value }}"{% endfor %}{% endif %}>
                {{ action.label|default:action.text|default:action }}
              </button>
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if extra_actions_html %}
          {{ extra_actions_html|safe }}
        {% endif %}
        </div>
      {% endif %}
    {% endwith %}
    {% if form_client_helpers_disabled|default:False %}
    {% else %}
      <script>
        (function() {
          const script = document.currentScript;
          if (!script) { return; }
          const form = script.closest('form');
          if (!form) { return; }

          const focusFirstInvalidField = () => {
            const invalidField = form.querySelector('.is-invalid, :invalid');
            if (invalidField && typeof invalidField.focus === 'function') {
              invalidField.focus({ preventScroll: false });
            }
          };

          const applyWasValidated = () => {
            form.classList.add('was-validated');
            focusFirstInvalidField();
          };

          const escapeSelector = (value) => {
            if (window.CSS && typeof window.CSS.escape === 'function') {
              return window.CSS.escape(value);
            }
            return value.replace(/([\s#.;,+>~:])/g, '\\$1');
          };

          const errorLinks = form.querySelectorAll('[data-error-field-target]');
          errorLinks.forEach((link) => {
            link.addEventListener('click', (event) => {
              const targetId = link.getAttribute('data-error-field-target');
              if (!targetId) { return; }
              const target = form.querySelector(`#${escapeSelector(targetId)}`);
              if (!target) { return; }
              event.preventDefault();
              target.focus({ preventScroll: false });
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
          });

          form.addEventListener('submit', (event) => {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
              applyWasValidated();
            } else {
              form.classList.add('was-validated');
            }
          });

          if (form.querySelectorAll('.is-invalid, :invalid').length) {
            applyWasValidated();
          }
        })();
      </script>
    {% endif %}
  </form>
</div>
